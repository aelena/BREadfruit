; -- RULES FOR VENDOR SEARCH FORM 

Entity TBVendorName is TextBox in "frmSearch"
	with defaults
		enabled true
		visible
		value   ''
		label LABELS.VENDOR.NAME


	with actions
		hide btnCreateVendor
		set hidden vendorSearchResultGrid

	with rules
		
	with triggers
		TBVendorName.value changes

; ----------------------------------------------------------------------------	

Entity TBVendorCity is TextBox in "frmSearch"
	with defaults
		visible true
		value ""
		label LABELS.VENDOR.CITY

	with actions
		hide btnCreateVendor
		set hidden vendorSearchResultGrid

	with triggers
		this.value on change


; ----------------------------------------------------------------------------	

Entity TBVendorNumber is TextBox in "frmSearch"
	with defaults
		visible true
		value ''
		max length 10
		min length 10
		label LABELS.VENDOR.NUMBER

	with actions
		hide btnCreateVendor
		set hidden vendorSearchResultGrid

	with rules
		TBVendorNumber.text starts with '0' then
			set value MESSAGES.VALIDATIONS.SEARCH.NOTMANAGED in ErrorMessage
		TBVendorNumber.text not starts with '0' then
			set value '' in ErrorMessage					; o clear ErrorMessage

	with triggers
		this.value changes

	with constraints
		only numbers
			
; ----------------------------------------------------------------------------	

Entity TBVendorIFA is TextBox in "frmSearch"
	with defaults
		visible true
		value ''
		label LABELS.VENDOR.TAXCODE4

	with actions
		hide btnCreateVendor
		set hidden vendorSearchResultGrid

	with triggers
		this.value changes
		
; ----------------------------------------------------------------------------	


 Entity DDLVDCountry is DropDownList in "frmSearch"
	with defaults
		visible true
		value USER.COUNTRY		; preselect user country if there is data in SCD for this user
		mandatory true
		load data from DATASOURCE.ENTERPRISE.WORLD_COUNTRIES
		label LABELS.GENERIC.COUNTRY

	with actions
		set value '' in ErrorMessage
		hide vendorSearchResultGrid
		hide btnCreateVendor
		load data from DATASOURCE.ENTERPRISE.WORLD_COUNTRIES ;{"Country":"ES","Active":true, "Age":30, "Title":"No reason to fear this" }


	with rules
		DDLVDCountry.value in {"FR","GF","GP","RE","MQ","YT","NC","PF","PM","WF","MC"} then set value LABELS.VENDOR.SPECIFICLOCALIZED.SIRET in TBVendorVAT
		DDLVDCountry.value in {"PT","ES"} then set value LABELS.VENDOR.SPECIFICLOCALIZED.NIF in TBVendorVAT
		DDLVDCountry.value is "IT" then set value LABELS.VENDOR.SPECIFICLOCALIZED.PARTITAIVA in TBVendorVAT
		DDLVDCountry.value not in {"PT","ES","IT","FR","GF","GP","RE","MQ","YT","NC","PF","PM","WF","MC"} then set value "VAT" in TBVendorVAT
	
	with triggers
		this.value changes 

; ----------------------------------------------------------------------------	

Entity TBVendorVAT is TextBox in "frmSearch"
	with defaults
		visible true
		value ''
		label LABELS.GENERIC.VAT

	with actions
		hide btnCreateVendor
		set hidden vendorSearchResultGrid

	with triggers
		this.value changes
		
; ----------------------------------------------------------------------------	


Entity DDLCDCountry is DropDownList in "frmSearch"
	with defaults
		visible true
		; we need to define these things too, let's calle them "data constants" for now...
		value User.Country
		load data from DATASOURCE.ACTIVE_COUNTRIES
		label LABELS.GENERIC.COUNTRY
	
	with actions
		; load active companies for this country
		load data from DATASOURCE.ACTIVE_CCs with arguments {"Country" : this.value} in DDLCDCompany
		; purge the data in this dropdownlist
		clear DDLCDPurchOrg

	with triggers
		this.value changes

; ----------------------------------------------------------------------------	


Entity DDLCDCompany is DropDownList in "frmSearch"
	with defaults
		visible true
		value USER_COST_LOCATION_UNIT			; another data constant
		label LABELS.GENERIC.COMPANY

	with actions
		; load active companies for this country
		load data from DATASOURCES.ACTIVE_POs with arguments {"Arg1": this.value} in DDLCDPurchOrg 

	with triggers
		this.value changes

; ----------------------------------------------------------------------------	


Entity DDLCDPurchOrg is DropDownList in "frmSearch"
	with defaults
		visible true
		value ''
		label LABELS.GENERIC.PURCHASEORG
		

; ----------------------------------------------------------------------------	

Entity btnSearch is Button in "frmSearch"

	with defaults
		visible true
		label LABELS.BUTTONS.SEARCH

	with rules

		DDLVDCountry is empty then
			set value MESSAGES.VALIDATIONS.SEARCH.FILL01 in ErrorMessage
		
		TBVendorName is empty and TBVendorCity is empty and TBVendorIFA is empty then
			set value MESSAGES.VALIDATIONS.SEARCH.FILL01 in ErrorMessage

		TBVendorName is empty and TBVendorCity is empty and TBVendorName is empty and TBVendorIFA is empty and DDLVDCountry is empty and TBVendorVAT is empty then
			set value MESSAGES.VALIDATIONS.SEARCH.FILL02 in ErrorMessage
		
		TBVendorName is empty and TBVendorCity is not empty and TBVendorName is empty and TBVendorIFA is empty and DDLVDCountry is empty and TBVendorVAT is empty then
			set value MESSAGES.VALIDATIONS.SEARCH.FILL01 in ErrorMessage

		DDLCDCountry is empty or DDLCDCompany is empty or DDLCDPurchOrg is empty then
			set value MESSAGES.VALIDATIONS.SEARCH.FILL03 in ErrorMessage
		
		TBVendorName is not empty and DDLVDCountry is empty then
			set value MESSAGES.VALIDATIONS.SEARCH.FILL01 in ErrorMessage

		TBVendorIFA.text is not empty then DDLVDCountry not mandatory
		TBVendorIFA.value is not empty then DDLVDCountry mandatory

		; this has to be defined better
		; USER_HAS_NO_PERMISSIONS then
		;	set value MESSAGES.VALIDATIONS.SEARCH.NOAUTH in ErrorMessage
			

	with triggers

		; this onclick SEARCH_VENDORS with mappings
		;	 ABCDE.FGHIJ = TBVendorName
		;	 ... and so on


; ----------------------------------------------------------------------------	

Entity btnCreateVendor is Button in "frmSearch"
	with defaults
		visible false
		label LABELS.BUTTONS.CREATEVENDOR

	with rules
		; how to specify all that happens server side here?

	with triggers


; ----------------------------------------------------------------------------	

Entity vendorSearchResultGrid is Grid in "frmSearch"
	with defaults
		visible false
	

	; TODO: DEFINE CONVENTIONS FOR GRID BETTER

; ----------------------------------------------------------------------------	

; -- RULES FOR VENDOR MAIN FORM (MDM.ASPX)


Entity GD_Ctr_RiskClassification is DropDownList in "fmrMain"

	with defaults
		enabled true
		visible true
		value "00"
		load data from DATASOURCE.RISK_CLASSIFICATIONS

	with rules
		role not in {"RCO","ENQ","CLERK"} then enabled false

	with triggers
		; TODO FIND A BETTER WAY TO EXPRESS THIS....
		; BANK_INSERTED EVALUATE -----

; ----------------------------------------------------------------------------	


Entity GD_Adr_Country is DropDownList in "fmrMain"

	with defaults
		visible true
		enabled false					; this control is always disabled
		value USER.COUNTRY				; -- depends on country selected in search form, so this data has to be passed

; ----------------------------------------------------------------------------	

Entity GD_Ctr_VendorClassification is DropDownList in "fmrMain"

	with defaults
		visible true
		enabled true
		value "NG"
		load data from DATASOURCE.VENDOR_CLASSIFICATIONS

	with rules
		role in {"UPM","CPM"} then enabled false
		Vendor.Country is "ES" and GD_Ctr_TaxCode1.Text starts with {"P","Q","S"} then set value "G" in GD_Ctr_VendorClassification.Value
		Vendor.Country is "ES" and GD_Ctr_TaxCode1.Text starts with X then set value "NG" in GD_Ctr_VendorClassification.Value

; ----------------------------------------------------------------------------	

Entity CC_AM_BPClassification is DropDownList in "fmrMain"

	with defaults
		visible true
		enabled true
		value "NORM"
		load data from DATASOURCE.BP_CLASSIFICATIONS

	with rules
		CC_AM_BPClassification.Value in {"BPHR", "BPMR"} then AttachManager mandatory 

; ----------------------------------------------------------------------------	

Entity GD_Damex is DropDownList in "fmrMain"
	with defaults
		visible true
		enabled true
		value ''
		load data from DATASOURCE.YES_NO
		mandatory true

	with rules
		Request.FlowType not in {"VC", "VC_CC"} then GD_Damex not mandatory, GD_Damex not visible
; ----------------------------------------------------------------------------	

Entity GD_Ctr_IsNaturalPerson is DropDownList in "fmrMain"
	with defaults
		visible true
		enabled true
		value ''

	with rules
		Vendor.AccountGroup in {"YVT4", "YVT5"} then
			set DIV_ADDITIONAL_INFO_NATURAL_PERSON visible	
			; ALL FIELDS IN	DIV_ADDITIONAL_INFO_NATURAL_PERSON mandatory
		Vendor.Country is "ES" and GD_Ctr_TaxCode1.Text starts with {"P", "Q", "S"} then set value GD_Ctr_IsNaturalPerson.Checked false
		Vendor.Country is "ES" and GD_Ctr_TaxCode1.Text starts with X then set value GD_Ctr_IsNaturalPerson.Checked true

		; CHECK THIS -> 5) If request type creation for company or creation for sales org. or modification->enabled

